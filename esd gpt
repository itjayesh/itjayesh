#include "LPC17xx.h"
#include <stdint.h>

// LCD pins
#define LCD_RS 15
#define LCD_EN 16
#define LCD_D4 17
#define LCD_D5 18
#define LCD_D6 19
#define LCD_D7 20

// Buttons (SW1–SW4) on P2.0–P2.3
#define BTN1 0
#define BTN2 1
#define BTN3 2
#define BTN4 3

#define BIT(x) (1<<x)

static volatile uint32_t msTicks;

void SysTick_Handler(void){ msTicks++; }
void delayMs(uint32_t ms){ uint32_t t=msTicks; while((msTicks-t)<ms){} }

// === GPIO helpers ===
static inline void pinModeOut(uint8_t port,uint8_t pin){
    (&LPC_GPIO0)[port].FIODIR |= BIT(pin);
}
static inline void pinModeIn(uint8_t port,uint8_t pin){
    (&LPC_GPIO0)[port].FIODIR &= ~BIT(pin);
}
static inline void digitalWrite(uint8_t port,uint8_t pin,uint8_t val){
    if(val) (&LPC_GPIO0)[port].FIOSET = BIT(pin);
    else    (&LPC_GPIO0)[port].FIOCLR = BIT(pin);
}
static inline uint8_t digitalRead(uint8_t port,uint8_t pin){
    return ((&LPC_GPIO0)[port].FIOPIN >> pin) & 1;
}

// === LCD low-level ===
void lcdPulse(void){
    digitalWrite(0,LCD_EN,1);
    for(volatile int i=0;i<1000;i++);
    digitalWrite(0,LCD_EN,0);
    for(volatile int i=0;i<1000;i++);
}
void lcdSend4(uint8_t n){
    digitalWrite(0,LCD_D4,(n>>0)&1);
    digitalWrite(0,LCD_D5,(n>>1)&1);
    digitalWrite(0,LCD_D6,(n>>2)&1);
    digitalWrite(0,LCD_D7,(n>>3)&1);
    lcdPulse();
}
void lcdCmd(uint8_t c){
    digitalWrite(0,LCD_RS,0);
    lcdSend4(c>>4);
    lcdSend4(c&0x0F);
    delayMs(2);
}
void lcdData(uint8_t d){
    digitalWrite(0,LCD_RS,1);
    lcdSend4(d>>4);
    lcdSend4(d&0x0F);
}
void lcdInit(void){
    pinModeOut(0,LCD_RS); pinModeOut(0,LCD_EN);
    pinModeOut(0,LCD_D4); pinModeOut(0,LCD_D5);
    pinModeOut(0,LCD_D6); pinModeOut(0,LCD_D7);

    delayMs(50);
    lcdSend4(0x03); delayMs(5);
    lcdSend4(0x03); delayMs(5);
    lcdSend4(0x03); delayMs(1);
    lcdSend4(0x02);

    lcdCmd(0x28); // 4-bit,2-line
    lcdCmd(0x0C); // display on
    lcdCmd(0x01); delayMs(2);
    lcdCmd(0x06);
}
void lcdClear(void){ lcdCmd(0x01); delayMs(2); }
void lcdGoto(uint8_t r,uint8_t c){ lcdCmd(0x80|(r?0x40:0)+c); }
void lcdPrint(const char *s){ while(*s) lcdData(*s++); }

// === Buttons ===
void btnInit(void){
    for(int i=0;i<4;i++){
        pinModeIn(2,i);
        // pull-up enable
        uint32_t *mode = &LPC_PINCON->PINMODE4;
        *mode &= ~(3u<<(i*2));  // 00 = pull-up
    }
}
uint8_t btnPressed(uint8_t pin){
    return digitalRead(2,pin)==0;
}

// === MAIN ===
int main(void){
    SystemInit();
    SysTick_Config(SystemCoreClock/1000);
    lcdInit();
    btnInit();

    lcdClear();
    lcdGoto(0,0);
    lcdPrint("EVM Voting Mach");
    lcdGoto(1,0);
    lcdPrint("Press a Button");
    delayMs(1000);

    lcdClear();
    lcdGoto(0,0); lcdPrint("1:BJP 2:Cong");
    lcdGoto(1,0); lcdPrint("3:Local 4:NOTA");

    while(1){
        if(btnPressed(BTN1)){
            lcdClear();
            lcdGoto(0,0); lcdPrint("You voted:");
            lcdGoto(1,0); lcdPrint("BJP");
            delayMs(800);
            lcdClear();
            lcdGoto(0,0); lcdPrint("1:BJP 2:Cong");
            lcdGoto(1,0); lcdPrint("3:Local 4:NOTA");
            while(btnPressed(BTN1));
        }
        if(btnPressed(BTN2)){
            lcdClear();
            lcdGoto(0,0); lcdPrint("You voted:");
            lcdGoto(1,0); lcdPrint("Congress");
            delayMs(800);
            lcdClear();
            lcdGoto(0,0); lcdPrint("1:BJP 2:Cong");
            lcdGoto(1,0); lcdPrint("3:Local 4:NOTA");
            while(btnPressed(BTN2));
        }
        if(btnPressed(BTN3)){
            lcdClear();
            lcdGoto(0,0); lcdPrint("You voted:");
            lcdGoto(1,0); lcdPrint("Local Party");
            delayMs(800);
            lcdClear();
            lcdGoto(0,0); lcdPrint("1:BJP 2:Cong");
            lcdGoto(1,0); lcdPrint("3:Local 4:NOTA");
            while(btnPressed(BTN3));
        }
        if(btnPressed(BTN4)){
            lcdClear();
            lcdGoto(0,0); lcdPrint("You voted:");
            lcdGoto(1,0); lcdPrint("NOTA");
            delayMs(800);
            lcdClear();
            lcdGoto(0,0); lcdPrint("1:BJP 2:Cong");
            lcdGoto(1,0); lcdPrint("3:Local 4:NOTA");
            while(btnPressed(BTN4));
        }
    }
}
